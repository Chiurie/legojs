/**
 * lego.min.js v0.0.8
 * (c) 2016 Ronghui Yu
 * @license MIT
 */
"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}function __async(t){return new Promise(function(e,r){function n(o,s){try{var a=t[s?"throw":"next"](o)}catch(t){return void r(t)}a.done?e(a.value):Promise.resolve(a.value).then(n,i)}function i(t){n(t,1)}n()})}var Events=_interopDefault(require("events")),director=require("director"),h$1=_interopDefault(require("virtual-dom/h")),diff=_interopDefault(require("virtual-dom/diff")),createElement=_interopDefault(require("virtual-dom/create-element")),patch=_interopDefault(require("virtual-dom/patch")),object_observe=require("object.observe"),Util={},View=function(t){var e=this;if(void 0===t&&(t={}),this.options={events:null,listen:null,config:{}},Lego.$.extend(!0,this.options,t),this.Eventer=Lego.Eventer,this.setElement(this.options.el),this.data=this.options.data||this.data||{},this.server=null,this._renderView(),this._observe(),this.options.dataSource){var r=this.options.dataSource;r.server&&("function"==typeof r.server?this.server=new r.server:this.server=r.server,this.server.fetch(r.api,function(t){Array.isArray(t)?e.data.list=t:e.data=t,e.refresh()}))}};View.prototype._renderView=function(){var t=this.render();if(Lego.config.isVDom&&"string"!=typeof t){var e=this._getVdom(t);this.oldTree=e,this.rootNode=Lego.createElement(e),this.$el[this.options.insert](this.rootNode)}"string"==typeof t&&this._renderHtml(t),this.options.components.length&&this.options.components.forEach(function(t,e){Lego.create(t)})},View.prototype._getVdom=function(t){var e=this.options.tagName,r={id:this.options.id};return h(e,r,[t])},View.prototype._renderHtml=function(t){var e=$(document.createElement(this.options.tagName)).html(t);e.attr("id",this.options.id),this.$el[this.options.insert](e)},View.prototype._observe=function(){var t=this;this.data&&"object"==typeof this.data&&Object.observe(this.data,function(e){var r=t.render();if(Lego.config.isVDom){var n=t._getVdom(r),i=Lego.diff(t.oldTree,n);t.rootNode=Lego.patch(t.rootNode,i),t.oldTree=n}"string"==typeof r&&t._renderHtml(r)})},View.prototype.setElement=function(t){return this.undelegateEvents(),this._setElement(t),this.delegateEvents(),this},View.prototype._setElement=function(t){this.$el=t instanceof Lego.$?t:Lego.$(t),this.el=this.$el[0]},View.prototype.delegateEvents=function(){var t=this,e=this.options.events,r=/^(\S+)\s*(.*)$/;if(!e)return this;this.undelegateEvents();for(var n in e){var i=e[n];if("function"!=typeof i&&(i=t[i]),i){var o=n.match(r);t.delegate(o[1],o[2],i.bind(t))}}return this},View.prototype.delegate=function(t,e,r){return this.$el.on(t+".delegateEvents"+this.options.id,e,r),this},View.prototype.undelegateEvents=function(){return this.$el&&this.$el.off(".delegateEvents"+this.options.id),this},View.prototype.undelegate=function(t,e,r){return this.$el.off(t+".delegateEvents"+this.options.id,e,r),this},View.prototype.$=function(t){return this.$el.find(t)},View.prototype.render=function(){return this},View.prototype.refresh=function(){Lego.config.isVDom?this.data.__v=Lego.randomKey():this._renderView()},View.prototype.remove=function(){this.undelegateEvents(),this.$el.children().remove()};var Data=function(t){var e=this;void 0===t&&(t={}),this.datas=new Map,this.Eventer=Lego.Eventer;for(var r in t)e.datas.set(r,t[r]),e.datas.get(r).data={}};Data.prototype.setOptions=function(t,e){if(void 0===e&&(e={}),!this.datas.get(t))return this;var r=Lego.$.extend(!0,this.datas.get(t),e);return this.datas.set(t,r),this},Data.prototype.fetch=function(t,e){var r=this;t=Array.isArray(t)?t:[t],this.__fetch(t).then(function(n){t.forEach(function(t,e){var i=n[e],o=r.datas.get(t).listTarget,s=r.datas.get(t).model;i&&(o&&Array.isArray(i[o])&&s&&i[o].forEach(function(t,e){i[o][e]=Lego.$.extend({},s,t)}),o||!Array.isArray(i)||s||i.forEach(function(t,e){i[e]=Lego.$.extend({},s,t)})),r.datas.get(t).data=i}),"function"==typeof e&&e(r.parse(n))})},Data.prototype.__fetch=function(t){return __async(regeneratorRuntime.mark(function e(){var r,n,i,o,s,a,c;return regeneratorRuntime.wrap(function(e){for(var u=this;;)switch(e.prev=e.next){case 0:r=u,n=[],e.prev=1,i=t.map(function(t){return __async(regeneratorRuntime.mark(function e(){var n,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.datas.get(t)||{},Lego.$.isEmptyObject(n.data)||n.reset){e.next=7;break}return e.next=4,n.data;case 4:return e.abrupt("return",e.sent);case 7:if(!r.datas.has(t)||!n.url||!Lego.$.isEmptyObject(n.data)&&!n.reset){e.next=13;break}return i=new Request(n.url,{method:n.method||"GET",headers:n.headers||"none",mode:"same-origin",credentials:"include",body:n.body||void 0}),e.next=11,fetch(i);case 11:return o=e.sent,e.abrupt("return",o.json());case 13:case"end":return e.stop()}},e,this)})())}),s=regeneratorRuntime.values(i);case 4:if((a=s.next()).done){e.next=12;break}return o=a.value,e.next=8,o;case 8:c=e.sent,n.push(c);case 10:e.next=4;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(1),debug.log(e.t0);case 17:return e.abrupt("return",n);case 18:case"end":return e.stop()}},e,this,[[1,14]])}).call(this))},Data.prototype.parse=function(t){return t},Data.prototype.getData=function(t){return t?this.datas.get(t)?this.datas.get(t):{}:this.datas},!function(t){function e(t,e,r,i){var o=e&&e.prototype instanceof n?e:n,s=Object.create(o.prototype),a=new p(i||[]);return s._invoke=u(t,r,a),s}function r(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}function n(){}function i(){}function o(){}function s(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function a(t){this.arg=t}function c(t){function e(n,i,o,s){var c=r(t[n],t,i);if("throw"!==c.type){var u=c.arg,f=u.value;return f instanceof a?Promise.resolve(f.arg).then(function(t){e("next",t,o,s)},function(t){e("throw",t,o,s)}):Promise.resolve(f).then(function(t){u.value=t,o(u)},s)}s(c.arg)}function n(t,r){function n(){return new Promise(function(n,i){e(t,r,n,i)})}return i=i?i.then(n,n):n()}"object"==typeof process&&process.domain&&(e=process.domain.bind(e));var i;this._invoke=n}function u(t,e,n){var i=E;return function(o,s){if(i===x)throw new Error("Generator is already running");if(i===$){if("throw"===o)throw s;return d()}for(;;){var a=n.delegate;if(a){if("return"===o||"throw"===o&&a.iterator[o]===v){n.delegate=null;var c=a.iterator.return;if(c){var u=r(c,a.iterator,s);if("throw"===u.type){o="throw",s=u.arg;continue}}if("return"===o)continue}var u=r(a.iterator[o],a.iterator,s);if("throw"===u.type){n.delegate=null,o="throw",s=u.arg;continue}o="next",s=v;var f=u.arg;if(!f.done)return i=A,f;n[a.resultName]=f.value,n.next=a.nextLoc,n.delegate=null}if("next"===o)n.sent=n._sent=s;else if("throw"===o){if(i===E)throw i=$,s;n.dispatchException(s)&&(o="next",s=v)}else"return"===o&&n.abrupt("return",s);i=x;var u=r(t,e,n);if("normal"===u.type){i=n.done?$:A;var f={value:u.arg,done:n.done};if(u.arg!==_)return f;n.delegate&&"next"===o&&(s=v)}else"throw"===u.type&&(i=$,o="throw",s=u.arg)}}}function f(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function h(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(f,this),this.reset(!0)}function l(t){if(t){var e=t[m];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,n=function e(){for(;++r<t.length;)if(g.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=v,e.done=!0,e};return n.next=n}}return{next:d}}function d(){return{value:v,done:!0}}var v,g=Object.prototype.hasOwnProperty,y="function"==typeof Symbol?Symbol:{},m=y.iterator||"@@iterator",w=y.toStringTag||"@@toStringTag",b="object"==typeof module,L=t.regeneratorRuntime;if(L)return void(b&&(module.exports=L));L=t.regeneratorRuntime=b?module.exports:{},L.wrap=e;var E="suspendedStart",A="suspendedYield",x="executing",$="completed",_={},j=o.prototype=n.prototype;i.prototype=j.constructor=o,o.constructor=i,o[w]=i.displayName="GeneratorFunction",L.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===i||"GeneratorFunction"===(e.displayName||e.name))},L.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,o):(t.__proto__=o,w in t||(t[w]="GeneratorFunction")),t.prototype=Object.create(j),t},L.awrap=function(t){return new a(t)},s(c.prototype),L.async=function(t,r,n,i){var o=new c(e(t,r,n,i));return L.isGeneratorFunction(r)?o:o.next().then(function(t){return t.done?t.value:o.next()})},s(j),j[m]=function(){return this},j[w]="Generator",j.toString=function(){return"[object Generator]"},L.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},L.values=l,p.prototype={constructor:p,reset:function(t){var e=this;if(this.prev=0,this.next=0,this.sent=this._sent=v,this.done=!1,this.delegate=null,this.tryEntries.forEach(h),!t)for(var r in this)"t"===r.charAt(0)&&g.call(e,r)&&!isNaN(+r.slice(1))&&(e[r]=v)},stop:function(){this.done=!0;var t=this.tryEntries[0],e=t.completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){function e(e,r){return s.type="throw",s.arg=t,n.next=e,!!r}var r=this;if(this.done)throw t;for(var n=this,i=this.tryEntries.length-1;i>=0;--i){var o=r.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return e("end");if(o.tryLoc<=r.prev){var a=g.call(o,"catchLoc"),c=g.call(o,"finallyLoc");if(a&&c){if(r.prev<o.catchLoc)return e(o.catchLoc,!0);if(r.prev<o.finallyLoc)return e(o.finallyLoc)}else if(a){if(r.prev<o.catchLoc)return e(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(r.prev<o.finallyLoc)return e(o.finallyLoc)}}}},abrupt:function(t,e){for(var r=this,n=this.tryEntries.length-1;n>=0;--n){var i=r.tryEntries[n];if(i.tryLoc<=r.prev&&g.call(i,"finallyLoc")&&r.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=t,s.arg=e,o?this.next=o.finallyLoc:this.complete(s),_},complete:function(t,e){if("throw"===t.type)throw t.arg;"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=t.arg,this.next="end"):"normal"===t.type&&e&&(this.next=e)},finish:function(t){for(var e=this,r=this.tryEntries.length-1;r>=0;--r){var n=e.tryEntries[r];if(n.finallyLoc===t)return e.complete(n.completion,n.afterLoc),h(n),_}},catch:function(t){for(var e=this,r=this.tryEntries.length-1;r>=0;--r){var n=e.tryEntries[r];if(n.tryLoc===t){var i=n.completion;if("throw"===i.type){var o=i.arg;h(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:l(t),resultName:e,nextLoc:r},_}}}("object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:void 0);var Lego$1=function(t){return void 0===t&&(t={}),window.h=h$1,this.createElement=createElement,this.diff=diff,this.patch=patch,this.util=Util,this.config={alias:"Lego",version:"1.0.0",$:null,isDebug:!0,isAnimate:!1,isPermit:!1,isMultiWindow:!1,isVDom:!0,pageEl:"",defaultApp:"",rootUri:"",routerConfig:{},screenWidth:window.innerWidth},Object.assign(this.config,t),this._debugger(),this.config.$?(window.$=this.$=this.config.$,this.$el=this.$,this.prevApp="",this.currentApp="index",this.Event=Events,this.Router=director.Router,this.View=View,this.Data=Data,this.views={},this.datas={},this.permis={},this.timer={},this.routers=new Map,this.Eventer=new Events,window[this.config.alias]=window.Lego=this,this.startApp(this.currentApp),this):void debug.error("\u8bf7\u5148\u8bbe\u7f6e\u53c2\u6570$")};Lego$1.prototype.create=function(t){var e=this;void 0===t&&(t={});var r={id:"",el:this.config.pageEl,tagName:"div",config:{},insert:"html",permis:null,view:null,components:[],events:{},listen:{},scrollbar:null,data:null,dataSource:null,onBefore:function(){},onAfter:function(){},onAnimateBefore:function(){},onAnimateAfter:function(){}};if(Object.assign(r,t),r.id=r.id||(this.config.alias+window.location.hash.replace(/\//g,"_")+"_"+r.el).replace(/#/g,""),r.onBefore=r.onBefore.bind(this),r.onAfter=r.onAfter.bind(this),r.onAnimateBefore=r.onAnimateBefore.bind(this),r.onAnimateAfter=r.onAnimateAfter.bind(this),r.permis){var n=r.permis.module,i=r.permis.operate,o=r.permis.hide,s=r.permis.userid||0;if(o&&!this.permis.check(n,i,s))return}"function"==typeof r.onBefore&&r.onBefore(),this.views[this.prevApp].has(r.el)&&!this.config.isMultiWindow&&(this.views[this.prevApp].get(r.el).remove(),this.views[this.prevApp].delete(r.el)),this.views[this.currentApp].has(r.el)&&!this.config.isMultiWindow&&(this.views[this.currentApp].get(r.el).remove(),this.views[this.currentApp].delete(r.el));var a=new r.view(r);if(this.views[this.currentApp].set(r.el,a),r.listen)for(var c in r.listen)e.Eventer.removeListener(c),e.Eventer.on(c,r.listen[c]);return"function"==typeof r.onAfter&&r.onAfter(a),a},Lego$1.init=function(t){void 0===t&&(t={}),new this(t)},Lego$1.prototype.randomKey=function(t){t=t||32;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=e.length,n="",i=0;i<t;i++)n+=e.charAt(Math.floor(Math.random()*r));return n},Lego$1.prototype._debugger=function(){if(window.debug={},!window.console)return function(){};if(this.config.isDebug)for(var t in console)"function"==typeof console[t]&&(debug[t]=console[t].bind(window.console));else for(var e in console)"function"==typeof console[e]&&(debug[e]=function(){})},Lego$1.prototype._initObj=function(t){this.views[t]=this.views[t]||new Map,this.timer[t]=this.timer[t]||new Map},Lego$1.prototype._clearObj=function(t){var e=this;this.prevApp!==this.currentApp&&this.timer[t].forEach(function(r,n){clearTimeout(r),clearInterval(r),e.timer[t].delete(n)})},Lego$1.prototype.startApp=function(t,e){void 0===e&&(e={});var r,n={onBefore:function(){},onAfter:function(){}},i=this;Object.assign(n,e);var o=window.location.hash.replace(/#/,""),s=0==o.indexOf("/")?o.replace(/\//,""):"";s="index"!==s?s:"",t=t||s||this.config.defaultApp,r=t.indexOf("/")>0?t.split("/")[0]:t,this.prevApp=this.currentApp,this.currentApp=r,this._initObj(r),"function"==typeof n.onBefore&&n.onBefore(),this.$(this.config.pageEl).scrollTop(0),this.$.ajax({type:"GET",url:this.config.rootUri+r+"/app.js?"+this.config.version,dataType:"script",crossDomain:!0,cache:!0,success:function(e){t&&"index"!==r&&i.routers.get(r).setRoute(t),i._clearObj(i.prevApp),"function"==typeof n.onAfter&&n.onAfter(e)},error:function(t){debug.error("Failed to load application module!")}})},Lego$1.prototype.getUrlParam=function(t){if(window.pageParams={},window.pageParams[t])return window.pageParams[t];var e=decodeURI(document.location.search);if(e.indexOf("?")>=0){for(var r=e.substr(1).split("&"),n=[],i=0;i<r.length;i++)n=r[i].split("="),window.pageParams[n[0]]=n[1];return window.pageParams[t]||""}return""},Lego$1.prototype.trigger=function(t,e){this.Eventer.emit(t,e)},Lego$1.prototype.getAppName=function(){var t=window.location.hash.replace(/#/,"");return t=0==t.indexOf("/")?t.replace(/\//,""):"",t.split("/")[0]||this.config.defaultApp},Lego$1.prototype.getView=function(t,e){return void 0===e&&(e=this.getAppName()),t=t instanceof this.$?t:this.$(t),t.length&&this.views[e].get(t)?this.views[e].get(t):null},Lego$1.prototype.setTimer=function(t,e){if(t&&e){var r=this.timer[this.getAppName()],n=r.get(t);n&&(clearTimeout(n),clearInterval(n),r.clear()),r.set(t,e)}},Lego$1.prototype.router=function(t){var e=this.currentApp;if("index"!=e){if(!this.routers.has(e)){var r=this.Router(t).init();this.routers.set(e,r)}return this.routers.get(e)}},module.exports=Lego$1;